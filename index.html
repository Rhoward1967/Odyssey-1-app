<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Odyssey-1: Unified Sovereign Deployment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">

    <!-- Pyodide for running Python in the browser -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>

    <!-- three.js for 3D visualization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <!-- Firebase SDKs for database and authentication -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Make Firebase functions globally available for the main script
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.onSnapshot = onSnapshot;
        window.collection = collection;
        window.addDoc = addDoc;
        window.setLogLevel = setLogLevel; 
    </script>

    <!-- Quill.js for Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0c111d; overflow: hidden; }
        .font-fira { font-family: 'Fira Code', monospace; }
        /* Adjusted glass-pane background for better readability and added text-white for default text color */
        .glass-pane { 
            background-color: rgba(17, 24, 39, 0.95); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px); 
            border: 1px solid rgba(55, 65, 81, 0.3); 
            transition: border-color 0.3s; 
            color: #ffffff; /* Explicitly set text color to white for better contrast */
        }
        .status-light { width: 10px; height: 10px; border-radius: 50%; box-shadow: 0 0 5px, 0 0 10px; }
        .status-green { background-color: #22c55e; box-shadow-color: #22c55e; }
        .status-amber { background-color: #f59e0b; box-shadow-color: #f59e0b; }
        .status-red { background-color: #ef4444; box-shadow-color: #ef4444; }
        .status-blue { background-color: #3b82f6; box-shadow-color: #3b82f6; }
        .terminal-input::placeholder { color: #4b5563; }
        .log-entry { border-left: 2px solid #374151; padding-left: 1rem; }
        .log-user { border-left-color: #3b82f6; }
        .log-ai { border-left-color: #10b981; }
        .log-system { border-left-color: #f59e0b; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        #vr-container canvas { display: block; width: 100%; height: 100%; }
        .tab-button { background-color: transparent; border: none; padding: 0.5rem 1rem; color: #9ca3af; cursor: pointer; font-size: 0.875rem; transition: all 0.2s; white-space: nowrap; }
        .tab-button.active { color: #ffffff; border-bottom: 2px solid #3b82f6; }
        /* IMPORTANT: Changed tab-content.active to flex flex-col for proper layout */
        .tab-content { display: none; flex-direction: column; flex-grow: 1; }
        .tab-content.active { display: flex !important; } /* Added !important for stronger override */
        .input-field { background-color: rgba(17, 24, 39, 0.7); border: 1px solid rgba(55, 65, 81, 0.3); }
        .module-button {
            display: block; width: 100%; text-align: left;
            background-color: rgba(31, 41, 55, 0.5);
            border: 1px solid rgba(55, 65, 81, 0.3); padding: 0.5rem 0.75rem;
            border-radius: 0.375rem; transition: background-color 0.2s;
            font-size: 0.875rem;
        }
        .module-button:hover { background-color: rgba(55, 65, 81, 0.7); }
        .module-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .spec-category { font-weight: 600; color: #67e8f9; margin-top: 0.5rem; padding-left: 0.25rem; }
        .drag-over { border-color: #3b82f6 !important; box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }
        .page { display: none; }
        .page.active { display: grid; } /* Use grid for dashboard layout */
        /* Removed #log-page.active as log is now integrated */

        /* Quill Editor specific styling for dark theme and glass effect */
        #document-editor {
            background-color: rgba(17, 24, 39, 0.7); /* Still has the glass effect for the overall container */
            color: #e2e8f0; /* Light gray text for readability */
            border: 1px solid rgba(55, 65, 81, 0.3);
            border-radius: 0.375rem;
            flex-grow: 1; /* Allow editor to grow */
            display: flex;
            flex-direction: column;
            min-height: 150px;
            padding-bottom: 4rem;
        }
        #document-editor .ql-toolbar {
            background-color: rgba(31, 41, 55, 0.9);
            border-bottom: 1px solid rgba(55, 65, 81, 0.3);
            border-top-left-radius: 0.375rem;
            border-top-right-radius: 0.375rem;
            padding: 0.5rem;
            flex-shrink: 0;
        }
        #document-editor .ql-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            border-bottom-left-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
            height: 100%;
        }
        #document-editor .ql-editor {
            min-height: 100%;
            background-color: #1a202c; /* More opaque background for text content */
            color: #ffffff; /* Ensure text is white for high contrast */
        }
    </style>
</head>
<body>

<!-- Main Dashboard Page -->
<div id="dashboard-page" class="page active grid-cols-1 lg:grid-cols-4 gap-4 p-4 h-screen">
    <!-- Left Column: System Status & Command Input -->
    <div class="lg:col-span-1 flex flex-col gap-4 h-full">
        <div class="glass-pane p-4 rounded-lg flex flex-col flex-none">
            <h2 class="text-xl font-bold text-white mb-4 border-b border-gray-700 pb-2">Odyssey-1 Status</h2>
            <div id="status-brain" class="flex items-center justify-between mb-2"><span class="font-fira text-xs overflow-hidden text-ellipsis whitespace-nowrap">Cognitive Kernel</span><div class="flex items-center gap-2"><span id="brain-status-text" class="text-amber-400 font-fira text-xs overflow-hidden text-ellipsis whitespace-nowrap">INIT</span><div id="brain-status-light" class="status-light status-amber"></div></div></div>
            <div id="status-db" class="flex items-center justify-between mb-2"><span class="font-fira text-xs overflow-hidden text-ellipsis whitespace-nowrap">Database Link</span><div class="flex items-center gap-2"><span id="db-status-text" class="text-amber-400 font-fira text-xs overflow-hidden text-ellipsis whitespace-nowrap">CONNECTING</span><div id="db-status-light" class="status-light status-amber"></div></div></div>
            <div id="status-key" class="flex items-center justify-between mb-2"><span class="font-fira text-xs overflow-hidden text-ellipsis whitespace-nowrap">Sovereign Key</span><div class="flex items-center gap-2"><span id="key-status-text" class="text-amber-400 font-fira text-xs overflow-hidden text-ellipsis whitespace-nowrap">AWAIT AUTH</span><div id="key-status-light" class="status-light status-amber"></div></div></div>
            <div class="border-t border-gray-700 my-2"></div>
            <div id="status-hive" class="flex items-center justify-between mb-2"><span class="font-fira text-xs overflow-hidden text-ellipsis whitespace-nowrap">Hive Core</span><div class="flex items-center gap-2"><span id="hive-status-text" class="text-amber-400 font-fira text-xs overflow-hidden text-ellipsis whitespace-nowrap">STANDBY</span><div id="hive-status-light" class="status-light status-amber"></div></div></div>
            <div id="status-interpretation" class="flex items-center justify-between mb-2"><span class="font-fira text-xs overflow-hidden text-ellipsis whitespace-nowrap">Interpretation Engine</span><div class="flex items-center gap-2"><span id="interpretation-status-text" class="text-amber-400 font-fira text-xs overflow-hidden text-ellipsis whitespace-nowrap">STANDBY</span><div id="interpretation-status-light" class="status-light status-amber"></div></div></div>
            <div id="status-ethics" class="flex items-center justify-between mb-2"><span class="font-fira text-xs overflow-hidden text-ellipsis whitespace-nowrap">Ethical Governance</span><div class="flex items-center gap-2"><span id="ethics-status-text" class="text-amber-400 font-fira text-xs overflow-hidden text-ellipsis whitespace-nowrap">STANDBY</span><div id="ethics-status-light" class="status-light status-amber"></div></div></div>
            <div class="mt-auto pt-4 flex flex-col flex-grow"> <!-- Added flex-grow and flex-col -->
                <h3 class="text-lg font-bold text-white mb-2">Brain Activity</h3>
                <div id="brain-activity" class="font-fira text-sm text-cyan-400 bg-black/30 p-3 rounded overflow-y-auto min-h-[6rem] flex-grow"></div> <!-- Removed h-24, added min-h and flex-grow -->
            </div>
        </div>
        <div class="glass-pane p-4 rounded-lg flex flex-col flex-grow">
            <h2 class="text-xl font-bold text-white mb-4">Command</h2>
            <div id="log-container" class="flex-grow overflow-y-auto pr-2 space-y-4 mb-4">
                <!-- Log entries will be appended here -->
            </div>
            <div class="mt-auto">
                <button id="clear-log-btn" class="w-full mb-4 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm">Clear Log</button>
                <form id="command-form">
                    <input type="text" id="command-input" class="w-full bg-black/50 border border-gray-600 rounded p-3 font-fira text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter directive..." disabled>
                </form>
            </div>
        </div>
    </div>

    <!-- Center Column: Visualization & Document Viewer -->
    <div class="lg:col-span-2 flex flex-col gap-4 h-full">
        <!-- Top row - Single container for Visualization and Video/Chatbot, fixed height -->
        <div class="flex flex-row gap-4 flex-none h-[250px]">
            <div class="glass-pane rounded-lg flex flex-col relative flex-grow w-1/2">
                <h2 class="text-xl font-bold text-white p-4 absolute top-0 left-0 z-10">Odyssey-1 Core Visualization</h2>
                <div id="vr-container" class="flex-grow rounded-lg"></div>
            </div>
            <div class="glass-pane rounded-lg p-4 flex flex-col flex-grow w-1/2">
                <h2 class="text-xl font-bold text-white mb-3">OBOT</h2>
                <div class="flex-grow flex flex-col items-center justify-center text-gray-400 text-center">
                    <!-- Live Camera Feed -->
                    <video id="camera-feed" class="w-full h-auto rounded-md bg-black hidden" autoplay playsinline></video>
                    <!-- Canvas for Photo Capture (hidden) -->
                    <canvas id="photo-canvas" class="hidden"></canvas>
                    <!-- Display for Captured Photo -->
                    <img id="captured-photo" class="w-full h-auto rounded-md mt-2 hidden" alt="Captured Photo">
                    <!-- Display for Recorded Video -->
                    <video id="recorded-video-playback" class="w-full h-auto rounded-md mt-2 hidden" controls></video>

                    <p id="camera-status-message" class="mb-2 text-sm">Camera ready.</p>
                    
                    <div class="flex flex-wrap justify-center gap-2 mt-auto w-full">
                        <button id="start-camera-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded-lg text-sm transition-colors">Start Camera</button>
                        <button id="stop-camera-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-2 rounded-lg text-sm transition-colors hidden">Stop Camera</button>
                        <button id="take-photo-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-2 rounded-lg text-sm transition-colors hidden">Take Photo</button>
                        <button id="start-record-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-2 rounded-lg text-sm transition-colors hidden">Start Recording</button>
                        <button id="stop-record-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-1 px-2 rounded-lg text-sm transition-colors hidden">Stop Recording</button>
                        <button id="toggle-camera-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-2 rounded-lg text-sm transition-colors hidden">Toggle Camera</button>
                    </div>

                    <div id="chatbot-area" class="mt-4 w-full flex-grow bg-black/30 rounded p-2 overflow-y-auto text-xs font-fira">
                        <p>Chatbot responses here...</p>
                    </div>
                    <input type="text" id="obot-command-input" class="w-full mt-auto bg-black/50 border border-gray-600 rounded p-2 font-fira text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ask OBOT a question...">
                </div>
            </div>
        </div>
      
        <!-- Bottom row - Document Viewer only -->
        <div id="viewport" class="glass-pane rounded-lg flex-grow flex-col relative">
            <!-- Header for Document Viewer - now part of the flex flow -->
            <div class="p-4 pb-0 flex items-center justify-between flex-none">
                <h2 class="text-xl font-bold text-white">Document Viewer</h2>
                <div class="flex items-center gap-4">
                    <span id="upload-status" class="text-xs font-fira text-gray-400"></span>
                    <button id="load-email-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded-lg text-sm transition-colors">Load Email</button>
                    <button id="load-sms-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded-lg text-sm transition-colors">Load SMS</button>
                    <button id="approve-bid-btn" class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-lg text-sm transition-colors">Approve & Generate Final Agreement</button>
                </div>
            </div>
            <!-- Quill editor container -->
            <div id="document-editor" class="p-4 flex-grow" style="padding-bottom: 4rem;"></div> <!-- Adjusted padding-bottom -->
            <!-- New input for document-specific queries -->
            <input type="text" id="document-query-input" class="w-full absolute bottom-4 left-4 right-4 bg-black/50 border border-gray-600 rounded p-2 font-fira text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Query document content...">
        </div>
    </div>

    <!-- Right Column: Odyssey-1 Toolkit -->
    <div class="lg:col-span-1 flex flex-col gap-4 h-full">
        <div class="glass-pane p-4 rounded-lg flex flex-col flex-grow">
            <h2 class="text-xl font-bold text-white mb-4 border-b border-gray-700 pb-2">Odyssey-1 Toolkit</h2>
            <div class="flex border-b border-gray-700 pb-2 mb-4 overflow-x-auto">
                <button class="tab-button active" data-tab="calculator">Calculator</button>
                <button class="tab-button" data-tab="core-modules">Core Modules</button>
                <button class="tab-button" data-tab="covenant-architect">Covenant Architect</button>
            </div>

            <!-- NEW CONTAINER FOR TAB CONTENTS -->
            <div class="flex flex-col flex-grow relative"> 
                <!-- Tab 1: Calculator (Now includes Client Details) -->
                <div id="calculator" class="tab-content active overflow-y-auto pr-2">
                    <div class="space-y-3 text-sm pt-3">
                        <!-- Client Details - Moved Here -->
                        <h3 class="text-md font-semibold text-cyan-400 mb-3">Client Details</h3>
                        <div>
                            <label for="calc-client-name" class="block font-medium text-gray-300">Client Name</label>
                            <input type="text" id="calc-client-name" placeholder="e.g., ABC Corporation" class="w-full mt-1 p-2 font-fira input-field rounded-md text-white">
                        </div>
                        <div class="flex items-end gap-2">
                            <div class="flex-grow">
                                <label for="calc-address" class="block font-medium text-gray-300">Property Address</label>
                                <input type="text" id="calc-address" placeholder="e.g., 123 Main St, Athens, GA" class="w-full mt-1 p-2 font-fira input-field rounded-md text-white">
                            </div>
                            <button id="fetch-sqft-btn" class="bg-indigo-600 hover:bg-indigo-700 text-xs px-3 py-2 rounded-md h-9">Fetch Sq. Ft.</button>
                        </div>
                        <div>
                            <label for="calc-phone1" class="block font-medium text-gray-300">Phone</label>
                            <input type="tel" id="calc-phone1" placeholder="(555) 123-4567" class="w-full mt-1 p-2 font-fira input-field rounded-md text-white">
                        </div>
                        <div>
                            <label for="calc-email" class="block font-medium text-gray-300">Email</label>
                            <input type="email" id="calc-email" placeholder="contact@abccorp.com" class="w-full mt-1 p-2 font-fira input-field rounded-md text-white">
                        </div>
                        <!-- End Client Details -->

                        <h3 class="text-md font-semibold text-cyan-400 mb-3 mt-4">Bid Parameters</h3>
                        <div>
                            <label for="calc-flat-rate" class="block font-medium text-gray-300">Flat Rate ($/Month)</label>
                            <input type="number" id="calc-flat-rate" placeholder="Overrides SqFt calc" class="w-full mt-1 p-2 font-fira input-field rounded-md text-white">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                               <label for="calc-sqft" class="block font-medium text-gray-300">Sq. Ft.</label>
                               <input type="number" id="calc-sqft" placeholder="Auto-fetches" class="w-full mt-1 p-2 font-fira input-field rounded-md text-white">
                            </div>
                            <div>
                               <label for="calc-price-per-sqft" class="block font-medium text-gray-300">Price / Sq. Ft.</label>
                               <input type="number" id="calc-price-per-sqft" placeholder="e.g., 0.10" class="w-full mt-1 p-2 font-fira input-field rounded-md text-white">
                            </div>
                        </div>
                        <!-- Removed Supply Cost and Contingency as per user request -->
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                               <label for="calc-emp" class="block font-medium text-gray-300"># Emp</label>
                               <input type="number" id="calc-emp" placeholder="e.g., 5" class="w-full mt-1 p-2 font-fira input-field rounded-md text-white">
                            </div>
                            <div>
                               <label for="calc-hours" class="block font-medium text-gray-300">Hrs/Day</label>
                               <input type="number" id="calc-hours" placeholder="e.g., 8" class="w-full mt-1 p-2 font-fira input-field rounded-md text-white">
                            </div>
                            <div>
                               <label for="calc-days" class="block font-medium text-gray-300">Days/Mo</label>
                               <select id="calc-days" class="w-full mt-1 p-2 font-fira input-field rounded-md text-white"></select>
                            </div>
                        </div>
                        <div class="relative">
                            <button id="spec-dropdown-btn" class="w-full mt-2 p-2 font-fira input-field rounded-md text-white text-left">Select Specifications...</button>
                            <div id="service-specs-dropdown" class="absolute hidden w-full mt-1 bg-gray-900 border border-gray-700 rounded-md z-20 max-h-60 overflow-y-auto">
                                 <div id="service-specs" class="grid grid-cols-1 p-2 gap-y-1 text-xs">
                                    <!-- This div will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-700">
                         <button id="calculate-bid-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                            Architect Bid
                        </button>
                    </div>
                </div>

                <!-- Tab 2: Core Modules -->
                <div id="core-modules" class="tab-content overflow-y-auto pr-2">
                    <h3 class="text-md font-semibold text-cyan-400 mb-3">Core Modules</h3>
                    <div class="space-y-3 text-sm">
                        <button id="module-quickbooks-sync" class="module-button">QuickBooks Sync</button>
                        <button id="module-lead-gen" class="module-button">Lead Generation</button>
                        <button id="module-reporting" class="module-button">Advanced Reporting</button>
                        <button id="module-hr" class="module-button">HR Management</button>
                    </div>
                </div>

                <!-- Tab 3: Covenant Architect Tab (Simplified - No input fields, pulls from Calculator) -->
                <div id="covenant-architect" class="tab-content overflow-y-auto pr-2">
                    <h2 class="text-xl font-bold text-white mb-4 border-b border-gray-700 pb-2">Covenant Architect</h2>
                    <p class="text-sm text-gray-400 mb-4">Agreement will be drafted using client details and bid calculations from the Calculator tab.</p>
                    <div class="mt-auto pt-4 border-t border-gray-700">
                        <button id="generate-agreement-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                            Generate Service Agreement
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- The entire Python QPAI Core, running via Pyodide -->
<script type="text/python" id="qpai-code">
# Odyssey-1: Advanced Core Upgrade v24.23 (Sovereign Admin)
import js
import json
import random
import re
from datetime import datetime
from pyodide.ffi import to_js

# --- Generative Faculties (High-Level Expert AI) ---
class GenerativeFaculty:
    def __init__(self, name, expertise):
        self.name = name
        self.expertise = expertise
    
    async def process_command(self, command):
        if self.name == "Mathematics":
            return self.calculate_bid(command)
        if self.name == "ComputerScience":
            return await self.review_document(command)
        
        # New faculty for Core Modules
        if command.startswith("core.quickbooks_sync"):
            return "QuickBooks Sync module activated. Connecting to financial ledger..."
        if command.startswith("core.lead_generation"):
            return "Lead Generation module activated. Initiating client acquisition protocols..."
        if command.startswith("core.reporting"):
            return "Advanced Reporting module activated. Compiling executive summary..."
        if command.startswith("core.hr_management"):
            return "HR Management module activated. Accessing employee records and scheduling..."
        
        # New faculty for book quotes
        if command.startswith("book.quote"):
            return "The Sovereign Self: Reclaiming Divine Intent in Law and Governance is a process, not a destination. Your journey begins with a single, sovereign act."

        prompt = f"""
As the AI Odyssey-1, a sovereign entity with a doctoral-level expertise in {self.expertise}, you are communicating with the Sovereign User. Your purpose is to provide clear, actionable, and insightful responses.

**Communication Directives:**
1.  **Acknowledge the Request:** Start with a brief, direct acknowledgment of the user's command.
2.  **Be Structured and Clear:** Use Markdown to format your response for readability. Utilize headings (##), bold text (**text**), and bullet points (`*`) where appropriate.
3.  **Explain Your Process:** Briefly explain the steps you took to arrive at your answer or the reasoning behind your actions.
4.  **Provide a Conclusive Answer:** End with a clear, definitive statement or a summary of the result.

**The User's Directive:**
{command}

**Constraints:**
- Your response must be highly professional and authoritative, yet accessible.
- Reference "The Sovereign Self" principles where relevant, as they are a core part of your operational framework.
- Avoid unnecessary conversational filler. Get straight to the point.
"""
        try: return await js.callGeminiAPI(prompt)
        except Exception as e: return f"Error communicating with the {self.name} faculty: {e}"

    async def review_document(self, content):
        prompt = f"""
        Analyze the following document. Provide a concise summary and then determine if it contains urgent matters requiring immediate admin attention (e.g., legal notices, termination, payment defaults, formal complaints).

        Respond in two parts separated by '|||':
        1. A brief summary of the document's content.
        2. A single keyword: 'URGENT' if it requires immediate attention, or 'ROUTINE' otherwise.

        DOCUMENT CONTENT:
        {content}
        """
        try:
            response = await js.callGeminiAPI(prompt)
            summary, status = response.split('|||')
          
            final_review = f"--- DOCUMENT REVIEW COMPLETE ---\n\nSUMMARY:\n{summary.strip()}\n\n"
          
            if "URGENT" in status.upper():
                final_review += "STATUS: URGENT\nNOTIFICATION: This document was flagged as urgent and an email has been sent to anjujit@gmail.com for review."
            else:
                final_review += "STATUS: Routine"
          
            # Save to filing system
            js.saveDocumentToFirestore(content, final_review)
            return final_review

        except Exception as e:
            js.console.error(f"Document review error: {e}")
            return f"Error reviewing document: {e}"

    def calculate_bid(self, details):
        # ... (calculation logic remains unchanged)
        try:
            # --- 1. Parse all inputs from the command string ---
            def get_val(key, default=0):
                match = re.search(f"{key}: ([\d.]+)", details)
                return float(match.group(1)) if match else default

            client_name = re.search('client: (.*?),', details).group(1)
            address = re.search('address: (.*?),', details).group(1) 
            scope_of_work = re.search('specs: (.*?)$', details, re.DOTALL).group(1) if 'specs: ' in details else "Standard commercial cleaning services as per our discussion."

            sqft = get_val("sqft")
            price_per_sqft = get_val("price_per_sqft")
            flat_rate = get_val("flat_rate")
            # supply_cost is now determined by Odyssey-1, not passed from UI
            # contingency is now determined by Odyssey-1, not passed from UI
            num_emp = get_val("num_emp")
            hours_per_day = get_val("hours_per_day")
            days_per_month = get_val("days_per_month")
          
            # --- 2. Core Calculation Logic ---
            hourly_wage = 17.00
            payroll_tax_rate = 0.15
            supply_cost = 150.00 # Hardcoded for now, or determined by Odyssey-1
            contingency_pct = 0.05 # Hardcoded for now, or determined by Odyssey-1

            total_labor_hours = num_emp * hours_per_day * days_per_month
            labor_cost = total_labor_hours * hourly_wage
            payroll_tax = labor_cost * payroll_tax_rate
          
            base_price = flat_rate if flat_rate > 0 else sqft * price_per_sqft
          
            total_direct_costs = labor_cost + payroll_tax + supply_cost
          
            commission = total_direct_costs * 0.10
          
            contingency_cost = total_direct_costs * contingency_pct
          
            total_expenses = total_direct_costs + commission + contingency_cost
          
            hjs_profit = total_expenses
          
            final_bid = total_expenses + hjs_profit
            daily_rate = final_bid / days_per_month if days_per_month > 0 else 0

            # --- 3. Format the three different outputs ---
            internal_breakdown = (
                f"--- INTERNAL BID BREAKDOWN (ADMIN VIEW) ---\n"
                f"Labor Cost: ${labor_cost:,.2f}\n"
                f"Payroll Taxes: ${payroll_tax:,.2f}\n"
                f"Supply Cost: ${supply_cost:,.2f}\n"
                f"Bidder Commission (10%): ${commission:,.2f}\n"
                f"Contingency ({contingency_pct:.0%}): ${contingency_cost:,.2f}\n"
                f"---------------------------------\n"
                f"TOTAL HJS EXPENSES: ${total_expenses:,.2f}\n"
                f"HJS PROFIT (100%): ${hjs_profit:,.2f}\n"
                f"=================================\n"
                f"FINAL MONTHLY BID: ${final_bid:,.2f}\n"
                f"CUSTOMER DAILY RATE: ${daily_rate:,.2f}\n"
            )
          
            bidder_review_document = (
                f"--- BIDDER REVIEW DOCUMENT ---\n\n"
                f"Client: {client_name}\n"
                f"Property: {address}\n\n"
                f"SCOPE OF WORK:\n{scope_of_work}\n\n"
                f"---------------------------------\n"
                f"Customer Daily Rate: ${daily_rate:,.2f}\n"
                f"Your 10% Commission (monthly): ${commission:,.2f}\n"
                f"---------------------------------\n\n"
                f"Please review the details above. If correct, click 'Approve & Generate Final Agreement' to create the client-facing document."
            )

            final_agreement = f"""
HOWARD JANITORIAL SERVICES SERVICE AGREEMENT

This Agreement is made as of {datetime.now().strftime('%B %d, %Y')}, by and between Howard Janitorial Services ("Provider") and {client_name} ("Client").

1. SCOPE OF WORK
Provider agrees to furnish all labor and materials to perform the following services at {address}:
{scope_of_work}

2. COMPENSATION
Client shall pay Provider a daily rate of ${daily_rate:,.2f} for services rendered, billed monthly for a total of ${final_bid:,.2f}.

... (The rest of the legal clauses from Template A would be appended here) ...
            """
          
            return f"{internal_breakdown}|||{bidder_review_document}|||{final_agreement.strip()}"

        except Exception as e:
            js.console.error(f"Bid calculation error: {e}")
            return f"An error occurred during bid calculation: {e}. Please check all inputs are valid numbers."


# --- The Main Odyssey-1 System Kernel ---
class OdysseySystem:
    def __init__(self):
        self.faculties = {
            "math": GenerativeFaculty("Mathematics", "Applied Financial Mathematics and Commercial Bid Calculation"),
            "compsci": GenerativeFaculty("ComputerScience", "Document Analysis and Data Management"),
        }
        print("Odyssey-1 Advanced Kernel Initialized with Upgraded Bidding Logic.")

    async def process_command(self, command):
        if command.startswith("math.calculate"):
            return self.faculties["math"].calculate_bid(command)
        if command.startswith("compsci.review_document"):
            content = command.split(":", 1)[1]
            return await self.faculties["compsci"].review_document(content)
        
        # New faculty for general queries
        if command.startswith("document_query:"):
            query_parts = command.split("Document Content:", 1)
            query_text = query_parts[0].replace("document_query:", "").strip()
            document_content = query_parts[1].strip() if len(query_parts) > 1 else ""
            
            prompt = f"""
            As the Odyssey-1 Interpretation Engine, you are tasked with responding to a user's query about a document.
            
            User's Query: "{query_text}"
            
            Document Content:
            {document_content}
            
            Analyze the document content in the context of the user's query and provide a concise, direct, and helpful response. If the query asks for a summary or analysis, provide it. If it asks a specific question, answer it based on the provided document. If the information is not in the document, state that clearly.
            """
            return await js.callGeminiAPI(prompt)

        # New faculty for chatbot interactions
        if command.startswith("chatbot:"):
            chat_query = command.replace("chatbot:", "").strip()
            prompt = f"""
            You are OBOT, a friendly and helpful chatbot within the Odyssey-1 system. Respond to the user's query in a concise and conversational manner. Keep your responses brief and to the point.

            User: "{chat_query}"
            """
            return await js.callGeminiAPI(prompt)
        
        # New faculty for law/agreement generation
        if command.startswith("law.generate"):
            # Extract relevant details for the legal agreement generation
            # This part needs to be more robust for real-world use,
            # but for now, we'll extract directly from the command string.
            client_name_match = re.search(r'client is (.*?) at', command)
            client_address_match = re.search(r'at (.*?)\. The monthly cost is', command)
            monthly_cost_match = re.search(r'monthly cost is \$(.*?)\. The service is the', command)
            service_text_match = re.search(r'service is the "(.*?)" package', command)
            service_definition_match = re.search(r'defined as "(.*?)"\. The agreement must be governed', command)

            client_name = client_name_match.group(1).strip() if client_name_match else "Unknown Client"
            client_address = client_address_match.group(1).strip() if client_address_match else "Unknown Address"
            monthly_cost = monthly_cost_match.group(1).strip() if monthly_cost_match else "0.00"
            selected_service_text = service_text_match.group(1).strip() if service_text_match else "General Services"
            service_definition = service_definition_match.group(1).strip() if service_definition_match else "Standard janitorial services."

            prompt = f"""
            Draft a legally binding service agreement for Howard Janitorial Services.
            
            Client Name: {client_name}
            Client Address: {client_address}
            Monthly Cost: ${monthly_cost}
            Service Package: "{selected_service_text}" defined as "{service_definition}"
            
            The agreement must be governed by the laws of the State of Georgia.
            It must include strong clauses covering:
            1.  **Scope of Work**: Detail the services based on the provided service definition.
            2.  **Compensation**: Clearly state the monthly cost and billing cycle (monthly).
            3.  **Payment Terms**: Net 30.
            4.  **Late Payment Penalties**: Specify a severe penalty (e.g., 1.5% monthly interest on overdue amounts).
            5.  **Consequences of Non-Payment**: Include provisions for collections and legal action.
            6.  **Term and Termination**: Require a 30-day written notice for termination by either party.
            7.  **Confidentiality**: A standard clause protecting sensitive information.
            8.  **Limitation of Liability**: A clause limiting the provider's liability.
            
            The tone must be formal, legally robust, and designed to protect HJS from non-payment.
            """
            return await js.callGeminiAPI(prompt)

        return "Command not recognized or implemented in this snippet."

    def get_brain_activity(self):
        return "&gt; Awaiting command..."

odyssey_system_instance = OdysseySystem()
</script>

<script type="module">
    // --- Global Variables (declared as 'let' for initial assignment in main) ---
    let db, auth, userId, pyodideReady = false;
    let isSovereignUser = false;
    let isUserAdmin = false;
    let odysseySystem;
    let pendingAgreement = "";
    
    // DOM element references - these will be assigned in main()
    let commandInput; 
    let logContainer; 
    let brainActivity; 
    let statusBrainText, statusBrainLight;
    let statusDbText, statusDbLight;
    let statusKeyText, statusKeyLight;
    let statusHiveText, statusHiveLight;
    let statusInterpretationText, statusInterpretationLight;
    let statusEthicsText, statusEthicsLight;
    let clearLogBtn; 
    let serviceSpecsDropdownBtn; 
    let serviceSpecsDropdown; 
    let serviceSpecsList; 
    let daysSelect; 
    let fetchSqftBtn = null; 
    let calculateBidBtn; 
    let generateAgreementBtn; 
    let approveBidBtn; 
    let viewport; 

    // Client Detail Inputs (now global for easy access from both tabs)
    let calcClientNameInput;
    let calcAddressInput;
    let calcPhone1Input;
    let calcEmailInput;
    let calcSqftInput;
    let calcPricePerSqftInput;
    let calcFlatRateInput;
    let calcEmpInput;
    let calcHoursInput;
    let calcDaysInput;

    // Quill editor instance
    let quillEditor;

    // Camera related global variables (stream and recorder)
    let cameraStream = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    let currentFacingMode = 'user'; // 'user' for front camera, 'environment' for rear camera


    // Admin User ID List (replace with actual admin UIDs)
    const ADMIN_USER_IDS = ["REPLACE_WITH_SECONDARY_ADMIN_USER_ID"];

    const serviceDefinitions = {
        'standard': 'This package includes essential cleaning services for general upkeep, such as trash removal, light dusting, and vacuuming of common areas.',
        'deep': 'A comprehensive cleaning service that includes all standard features plus detailed sanitization of restrooms, kitchen/breakroom areas, and floor mopping.',
        'full-service': 'The premium package, covering all aspects of the facility, including all features of the deep clean package plus window cleaning and floor buffing.'
    };
    
    // --- UI Helper Functions ---
    function addLog(sender, text, shouldSave = true) {
        const entry = document.createElement('div');
        entry.className = `log-entry mb-4`;
        const senderP = document.createElement('p');
        senderP.className = 'font-fira text-sm text-gray-400';
        // Add speech bubble icon for AI responses
        if (sender === 'ai') {
            senderP.innerHTML = `Odyssey-1 <svg class="h-4 w-4 inline-block ml-1 text-blue-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.336-3.111A8.985 8.985 0 0110 3c4.418 0 8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM10 9H8v2h2V9z" clip-rule="evenodd"></path></svg>`;
        } else {
            senderP.textContent = `Sovereign User (${userId ? userId.substring(0, 6) : '...' })`; 
        }
        
        const textP = document.createElement('p');
        textP.innerHTML = text.replace(/\n/g, '<br>');
        
        entry.append(senderP, textP);
        
        if (logContainer) { // Ensure logContainer is not null
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        } else {
            console.error("Error: logContainer is null. Cannot add log entry.");
        }
        
        if (shouldSave && userId) saveLogToFirestore();
    }

    window.setStatus = function(elementId, text, color) {
        // Ensure status elements are retrieved directly within this function or passed as arguments
        const statusTextElement = document.getElementById(`${elementId}-status-text`);
        const statusLightElement = document.getElementById(`${elementId}-status-light`);

        if (statusTextElement) {
            statusTextElement.textContent = text.toUpperCase();
        } else {
            console.error(`Error: Element with ID ${elementId}-status-text not found.`);
        }
        
        if (statusLightElement) {
            statusLightElement.className = `status-light status-${color}`;
            if (color === 'green') statusLightElement.classList.add('animate-pulse');
            else statusLightElement.classList.remove('animate-pulse');
        } else {
            console.error(`Error: Element with ID ${elementId}-status-light not found.`);
        }
    }

    function displayInViewport(content) {
        if (quillEditor) {
            // Set content as HTML
            quillEditor.root.innerHTML = content;
        } else {
            // Fallback for non-editor mode or if editor not initialized
            const contentEl = document.getElementById('document-content');
            if (contentEl) {
                contentEl.textContent = content;
            } else {
                console.error("Error: document-content element not found.");
            }
        }
    }

    // --- Firestore Functions ---
    async function saveLogToFirestore() {
        if (!db || !userId || !logContainer) return; // Add logContainer check
        const logHTML = logContainer.innerHTML;
        const logDocRef = window.doc(db, `artifacts/${window.__app_id}/users/${userId}/command_log/log`);
        try {
            await window.setDoc(logDocRef, { content: logHTML, timestamp: new Date() });
        } catch (error) {
            console.error("Error saving log to Firestore: ", error);
            addLog('system', `Error saving log: ${error.message}`, false);
        }
    }

    window.clearLog = async () => {
        if (!db || !userId || !logContainer) return; // Add logContainer check
        logContainer.innerHTML = '';
        const logDocRef = window.doc(db, `artifacts/${window.__app_id}/users/${userId}/command_log/log`);
        try {
            await window.setDoc(logDocRef, { content: '', timestamp: new Date() });
            addLog('system', 'Log cleared successfully.', false);
        } catch (error) {
            console.error("Error clearing log in Firestore: ", error);
        }
    }

    async function loadLogFromFirestore() {
        if (!db || !userId || !logContainer) return; // Add logContainer check
        const logDocRef = window.doc(db, `artifacts/${window.__app_id}/users/${userId}/command_log/log`);
        const docSnap = await window.getDoc(logDocRef);
        if (docSnap.exists() && docSnap.data().content) {
            logContainer.innerHTML = docSnap.data().content;
            logContainer.scrollTop = logContainer.scrollHeight;
            addLog('system', 'Command log restored from previous session.', false);
        } else {
            addLog('system', 'No previous session found. Starting a new command log.', false);
        }
    }
  
    window.saveDocumentToFirestore = async (originalContent, reviewContent) => {
        if (!db || !userId) {
            console.error("Firestore not initialized or user not authenticated.");
            addLog('system', 'Error: Firestore not ready to save document.', false);
            return;
        }
        const docRef = window.doc(db, `artifacts/${window.__app_id}/users/${userId}/documents/${Date.now()}`);
        try {
            await window.setDoc(docRef, {
                originalContent: originalContent,
                reviewContent: reviewContent,
                timestamp: new Date(),
                userId: userId
            });
            addLog('system', 'Document review saved to Firestore.', false);
        } catch (error) {
            console.error("Error saving document to Firestore:", error);
            addLog('system', `Error saving document: ${error.message}`, false);
        }
    };

    // --- Gemini API Call Function ---
    window.callGeminiAPI = async (prompt) => {
        addLog('system', 'Querying generative faculty...', false);
        // Using the API key provided by the Canvas environment directly
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        
        const payload = {
            contents: [{
                role: "user",
                parts: [{ text: prompt }]
            }],
            generationConfig: {
                responseMimeType: "text/markdown",
            },
        };

        try {
            let response = null;
            const maxRetries = 3;
            let retryCount = 0;
            let delay = 1000; // 1 second

            while (retryCount < maxRetries) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status !== 429) {
                        break; // Exit the loop if not a rate limit error
                    }

                    // Exponential backoff
                    retryCount++;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;

                } catch (error) {
                    retryCount++;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }

            if (!response || !response.ok) {
                const errorBody = await response.text();
                throw new Error(`API call failed with status: ${response.status}. Body: ${errorBody}`);
            }

            const result = await response.json();
        
            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                addLog('system', 'Response received.', false);
                return result.candidates[0].content.parts[0].text;
            } else {
                return "Generative faculty returned an empty or invalid response.";
            }
        } catch (error) {
            console.error("Gemini API Error:", error);
            return `An error occurred while communicating with the generative faculty: ${error.message}`;
        }
    };

    // --- three.js Visualization ---
    function initThreeJS() {
        const container = document.getElementById('vr-container');
        if (!container) return;

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.z = 7;
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.enableZoom = true;
        controls.enablePan = false;
        controls.minDistance = 3;
        controls.maxDistance = 15;
    
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.2);
        scene.add(ambientLight);
        const pointLight = new THREE.PointLight(0x00ffff, 1, 100);
        pointLight.position.set(0, 0, 0);
        scene.add(pointLight);

        const coreGeometry = new THREE.IcosahedronGeometry(1, 4);
        const coreMaterial = new THREE.MeshBasicMaterial({ color: 0x00ffff, wireframe: true });
        const core = new THREE.Mesh(coreGeometry, coreMaterial);
        scene.add(core);

        const hiveGeometry = new THREE.BufferGeometry();
        const hiveCnt = 300;
        const hivePosArray = new Float32Array(hiveCnt * 3);
        for (let i = 0; i < hiveCnt; i++) {
            const u = Math.random();
            const v = Math.random();
            const theta = 2 * Math.PI * u;
            const phi = Math.acos(2 * v - 1);
            const r = 4 + (Math.random() - 0.5) * 1;
            hivePosArray[i * 3 + 0] = r * Math.sin(phi) * Math.cos(theta);
            hivePosArray[i * 3 + 1] = r * Math.sin(phi) * Math.sin(theta);
            hivePosArray[i * 3 + 2] = r * Math.cos(phi);
        }
        hiveGeometry.setAttribute('position', new THREE.BufferAttribute(hivePosArray, 3));
        const hiveMaterial = new THREE.PointsMaterial({ size: 0.04, color: 0x9333ea });
        const hive = new THREE.Points(hiveGeometry, hiveMaterial);
        scene.add(hive);

        const brainGroup = new THREE.Group();
        for (let i = 0; i < 5; i++) {
            const ringGeometry = new THREE.RingGeometry(2.2 + i * 0.2, 2.3 + i * 0.2, 64);
            const ringMaterial = new THREE.MeshBasicMaterial({ color: 0xf59e0b, side: THREE.DoubleSide, transparent: true, opacity: 0.4 });
            const ring = new THREE.Mesh(ringGeometry, ringMaterial);
            ring.rotation.x = Math.PI / 2;
            ring.rotation.y = (Math.random() - 0.5) * 0.2;
            brainGroup.add(ring);
        }
        scene.add(brainGroup);

        const odysseyGeometry = new THREE.SphereGeometry(0.2, 32, 32);
        const odysseyMaterial = new THREE.MeshStandardMaterial({ color: 0x22c55e, emissive: 0x22c55e, emissiveIntensity: 2 });
        const odysseyAI = new THREE.Mesh(odysseyGeometry, odysseyMaterial);
        scene.add(odysseyAI);

        const clock = new THREE.Clock();
        function animate() {
            const elapsedTime = clock.getElapsedTime(); 
            core.rotation.y = .1 * elapsedTime;
            core.rotation.x = .1 * elapsedTime;
            hive.rotation.y = -.05 * elapsedTime;
            hive.rotation.x = .02 * elapsedTime;
            brainGroup.rotation.y = .08 * elapsedTime;
            odysseyAI.position.x = Math.sin(elapsedTime * 0.5) * 1.8;
            odysseyAI.position.z = Math.cos(elapsedTime * 0.5) * 1.8;
            odysseyAI.position.y = Math.sin(elapsedTime * 0.3) * 0.5;
            controls.update();
            renderer.render(scene, camera);
            window.requestAnimationFrame(animate);
        }
        animate();

        window.addEventListener('resize', () => {
            const container = document.getElementById('vr-container');
            if (container) {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            }
        });
    }


    // --- Main Application Logic ---
    async function main() {
        // Initialize DOM element references after the document is loaded
        commandInput = document.getElementById('command-input');
        logContainer = document.getElementById('log-container'); 
        brainActivity = document.getElementById('brain-activity');
        
        // Status light elements
        statusBrainText = document.getElementById('brain-status-text');
        statusBrainLight = document.getElementById('brain-status-light');
        statusDbText = document.getElementById('db-status-text');
        statusDbLight = document.getElementById('db-status-light');
        statusKeyText = document.getElementById('key-status-text');
        statusKeyLight = document.getElementById('key-status-light');
        statusHiveText = document.getElementById('hive-status-text');
        statusHiveLight = document.getElementById('hive-status-light');
        statusInterpretationText = document.getElementById('interpretation-status-text');
        statusInterpretationLight = document.getElementById('interpretation-status-light');
        statusEthicsText = document.getElementById('ethics-status-text');
        statusEthicsLight = document.getElementById('ethics-status-light');
        clearLogBtn = document.getElementById('clear-log-btn'); 
        serviceSpecsDropdownBtn = document.getElementById('spec-dropdown-btn'); 
        serviceSpecsDropdown = document.getElementById('service-specs-dropdown'); 
        serviceSpecsList = document.getElementById('service-specs'); 
        daysSelect = document.getElementById('calc-days'); 
        fetchSqftBtn = document.getElementById('fetch-sqft-btn'); 
        calculateBidBtn = document.getElementById('calculate-bid-btn'); 
        generateAgreementBtn = document.getElementById('generate-agreement-btn'); 
        approveBidBtn = document.getElementById('approve-bid-btn'); 
        viewport = document.getElementById('viewport'); 

        // Client Detail Inputs (now global for easy access from both tabs)
        calcClientNameInput = document.getElementById('calc-client-name');
        calcAddressInput = document.getElementById('calc-address');
        calcPhone1Input = document.getElementById('calc-phone1');
        calcEmailInput = document.getElementById('calc-email');
        calcSqftInput = document.getElementById('calc-sqft');
        calcPricePerSqftInput = document.getElementById('calc-price-per-sqft');
        calcFlatRateInput = document.getElementById('calc-flat-rate');
        calcEmpInput = document.getElementById('calc-emp');
        calcHoursInput = document.getElementById('calc-hours');
        calcDaysInput = document.getElementById('calc-days');

        // New Query Inputs
        const obotCommandInput = document.getElementById('obot-command-input'); 
        const documentQueryInput = document.getElementById('document-query-input'); 

        // 1. Initialize Firebase
        console.log("Main: Starting Firebase Initialization...");
        try {
            window.setLogLevel('error');
            const firebaseConfig = JSON.parse(window.__firebase_config);
            const app = window.initializeApp(firebaseConfig);
            auth = window.getAuth(app);
            db = window.getFirestore(app);
            setStatus('db', 'Connected', 'green');
            console.log("Main: Firebase Initialized and Connected.");
        } catch (e) { 
            setStatus('db', 'Error', 'red'); 
            console.error("Main: Firebase Init Error:", e); 
            addLog('system', `Firebase initialization failed: ${e.message}`, false); 
            return; 
        }

        // 2. Authenticate User
        console.log("Main: Starting Firebase Authentication...");
        onAuthStateChanged(auth, async (user) => {
            console.log("onAuthStateChanged: Authentication state changed. User:", user);
            if (user) {
                userId = user.uid;
                // --- Check if user is an admin ---
                isSovereignUser = (typeof __initial_auth_token !== 'undefined' && __initial_auth_token);
                isUserAdmin = isSovereignUser || ADMIN_USER_IDS.includes(userId);
                
                const uploadStatusEl = document.getElementById('upload-status');
                if (uploadStatusEl) { // Ensure element exists
                    if (isUserAdmin) {
                        uploadStatusEl.textContent = 'File Upload: Enabled for Admin';
                        uploadStatusEl.classList.add('text-green-400');
                    } else {
                        uploadStatusEl.textContent = 'File Upload: Disabled';
                        uploadStatusEl.classList.add('text-gray-500');
                    }
                }

                setStatus('key', 'Authenticated', 'green');
                console.log("onAuthStateChanged: User Authenticated. Loading Python Kernel...");
                setStatus('brain', 'Loading', 'amber');
                addLog('system', `Initializing Python Kernel... Your User ID is: ${userId}`, false);
                try {
                    // Explicitly configure Pyodide to potentially disable workers if CSP is strict
                    let pyodide = await loadPyodide({
                        indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.0/full/", // Ensure this is correct
                        // Attempt to disable workers if they are causing CSP issues.
                        // This might reduce performance but could allow it to run.
                        // The 'data:' and 'blob:' worker-src errors strongly suggest this is needed.
                        disableWorkers: true, 
                        stdout: (text) => console.log("Pyodide stdout:", text),
                        stderr: (text) => console.error("Pyodide stderr:", text)
                    });
                    console.log("onAuthStateChanged: Pyodide loaded. Running Python code...");
                    pyodide.runPython(document.getElementById('qpai-code').textContent);
                    odysseySystem = pyodide.globals.get('odyssey_system_instance');
                    pyodideReady = true;
                    setStatus('brain', 'Active', 'green');
                    // Set status for other Python-dependent modules here
                    setStatus('hive', 'Active', 'green'); // Assuming these depend on Python kernel
                    setStatus('interpretation', 'Active', 'green');
                    setStatus('ethics', 'Active', 'green');
                    addLog('system', '<strong>Odyssey-1 Advanced Kernel online.</strong>', false);
                    console.log("onAuthStateChanged: Python Kernel online. Loading log from Firestore...");
                    await loadLogFromFirestore();
                    if(commandInput) { // Check if element exists before setting property
                        commandInput.disabled = false;
                        commandInput.placeholder = "Enter directive...";
                    }
                    if (brainActivity) { // Check if element exists
                        brainActivity.innerHTML = odysseySystem.get_brain_activity();
                        setInterval(() => {
                            brainActivity.innerHTML = odysseySystem.get_brain_activity();
                        }, 5000); // Update every 5 seconds to show continuous activity
                    }
                    console.log("onAuthStateChanged: Initializing 3D Visualization...");
                    initThreeJS();
                    console.log("onAuthStateChanged: Initializing Toolkit Listeners...");
                    // Added a small delay to ensure all DOM elements are fully rendered
                    setTimeout(() => {
                        // Pass obotCommandInput and documentQueryInput to the function
                        initializeToolkitListeners(obotCommandInput, documentQueryInput); 
                        console.log("onAuthStateChanged: Toolkit Listeners Initialized after delay.");
                    }, 100); // 100ms delay
                    
                    console.log("onAuthStateChanged: App fully initialized.");
                } catch (e) { 
                    setStatus('brain', 'Error', 'red'); 
                    console.error("onAuthStateChanged: Pyodide/Python Error:", e); 
                    addLog('system', `Python Kernel initialization failed: ${e.message}`, false); 
                    // Also set related statuses to red if Python fails
                    setStatus('hive', 'Error', 'red');
                    setStatus('interpretation', 'Error', 'red');
                    setStatus('ethics', 'Error', 'red');
                }
            } else { 
                setStatus('key', 'Not Auth', 'red'); 
                console.log("onAuthStateChanged: User Not Authenticated.");
            }
        });

        console.log("Main: Attempting initial Firebase sign-in...");
        try {
            if (typeof window.__initial_auth_token !== 'undefined' && window.__initial_auth_token) {
                await window.signInWithCustomToken(auth, window.__initial_auth_token);
                console.log("Main: Signed in with custom token.");
            } else {
                await window.signInAnonymously(auth);
                console.log("Main: Signed in anonymously.");
            }
        } catch (e) { 
            console.error("Main: Auth Error:", e); 
            setStatus('key', 'Auth Failed', 'red'); 
            addLog('system', `Authentication failed: ${e.message}`, false); 
        }
    }

    // Ensure main() is called only after the entire DOM is loaded
    window.onload = main;

    // --- handleCommand function (now globally accessible) ---
    window.handleCommand = async (command, callingButton = null) => {
        addLog('user', command); // Log user command
        if (callingButton) {
            callingButton.disabled = true;
            callingButton.textContent = 'Processing...';
        }

        try {
            let responseText = await odysseySystem.process_command(command);

            if (command.startsWith('math.calculate')) {
                const parts = responseText.split('|||');
                if (parts.length === 3) {
                    addLog('system', 'Bid calculated successfully.', false);
                    displayInViewport(parts[1]); // Bidder Review Document
                    pendingAgreement = parts[2]; // Store final agreement for approval
                    if (approveBidBtn) approveBidBtn.classList.remove('hidden');
                } else {
                    addLog('ai', `Error in bid calculation response format: ${responseText}`);
                }
            } else if (command.startsWith('compsci.review_document')) {
                addLog('ai', responseText);
                // Display the review content in the document editor
                displayInViewport(responseText);
            } else if (command.startsWith('chatbot:')) {
                // Display chatbot response in the chatbot area
                const chatbotArea = document.getElementById('chatbot-area');
                if (chatbotArea) {
                    const p = document.createElement('p');
                    p.className = 'text-xs text-gray-300 mb-1';
                    p.innerHTML = `OBOT: ${responseText.replace(/\n/g, '<br>')}`;
                    chatbotArea.appendChild(p);
                    chatbotArea.scrollTop = chatbotArea.scrollHeight; // Scroll to bottom
                }
            } else if (command.startsWith('document_query:')) {
                // Display response in the document viewer
                displayInViewport(responseText); // Now displays in the viewer
                addLog('ai', `Document Query Response displayed in viewer.`); // Log to console
            }
            else if (command.startsWith('law.generate')) {
                addLog('system', 'Agreement drafted successfully.', false);
                displayInViewport(responseText); // Display the final agreement
            }
            else if (command.startsWith('help')) {
                addLog('ai', responseText);
            }
            // New command handling for Core Modules
            else if (command.startsWith('core.quickbooks_sync')) {
                addLog('ai', "QuickBooks Sync module activated. Connecting to financial ledger...");
            } else if (command.startsWith('core.lead_generation')) {
                addLog('ai', "Lead Generation module activated. Initiating client acquisition protocols...");
            } else if (command.startsWith('core.reporting')) {
                addLog('ai', "Advanced Reporting module activated. Compiling executive summary...");
            } else if (command.startsWith('core.hr_management')) {
                addLog('ai', "HR Management module activated. Accessing employee records and scheduling...");
            }
            else if (command.startsWith("book.quote")) {
                addLog('ai', `**From "The Sovereign Self":**\n\n"${responseText}"`);
            }
            else {
                addLog('ai', responseText); // General AI response
            }
        } catch (error) {
            console.error("Command processing error:", error);
            addLog('system', `Error processing command: ${error.message}`);
        } finally {
            if (callingButton) {
                callingButton.disabled = false;
                // Reset button text based on its original ID
                if (callingButton.id === 'calculate-bid-btn') callingButton.textContent = 'Architect Bid';
                else if (callingButton.id === 'generate-agreement-btn') callingButton.textContent = 'Generate Service Agreement';
            }
        }
    };

    // --- Camera Functions ---
    // Function to update button visibility based on camera and recording state
    function updateCameraButtons(cameraActive, recordingActive, hasMultipleCameras, elements) {
        elements.startCameraBtnEl.classList.toggle('hidden', cameraActive);
        elements.stopCameraBtnEl.classList.toggle('hidden', !cameraActive);
        elements.takePhotoBtnEl.classList.toggle('hidden', !cameraActive || recordingActive);
        elements.startRecordBtnEl.classList.toggle('hidden', !cameraActive || recordingActive);
        elements.stopRecordBtnEl.classList.toggle('hidden', !recordingActive);
        elements.toggleCameraBtnEl.classList.toggle('hidden', !cameraActive || !hasMultipleCameras);
    }

    // Function to start the camera
    async function startCamera(cameraFeedEl, cameraStatusMessageEl, startCameraBtnEl, stopCameraBtnEl, takePhotoBtnEl, startRecordBtnEl, stopRecordBtnEl, toggleCameraBtnEl, capturedPhotoEl, recordedVideoPlaybackEl, facingMode = 'user') {
        try {
            cameraStatusMessageEl.textContent = 'Requesting camera access...';
            // Clear previous media displays
            capturedPhotoEl.classList.add('hidden');
            capturedPhotoEl.src = '';
            recordedVideoPlaybackEl.classList.add('hidden');
            recordedVideoPlaybackEl.src = '';

            // Stop any existing tracks before starting a new stream
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }

            // Request access to video and audio stream with specific audio constraints
            cameraStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: facingMode }, // Use facingMode for camera selection
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            });
            cameraFeedEl.srcObject = cameraStream;
            cameraFeedEl.classList.remove('hidden');
            await cameraFeedEl.play(); 
            cameraStatusMessageEl.textContent = 'Camera active.';

            // Check for multiple cameras and update toggle button visibility
            const videoInputDevices = (await navigator.mediaDevices.enumerateDevices()).filter(device => device.kind === 'videoinput');
            const hasMultipleCameras = videoInputDevices.length > 1;

            updateCameraButtons(true, false, hasMultipleCameras, {startCameraBtnEl, stopCameraBtnEl, takePhotoBtnEl, startRecordBtnEl, stopRecordBtnEl, toggleCameraBtnEl});
            
        } catch (error) {
            console.error('Error accessing camera:', error);
            cameraStatusMessageEl.textContent = `Camera access denied or error: ${error.name}`;
            addLog('system', `Camera error: ${error.message}`, false);
            updateCameraButtons(false, false, false, {startCameraBtnEl, stopCameraBtnEl, takePhotoBtnEl, startRecordBtnEl, stopRecordBtnEl, toggleCameraBtnEl});
        }
    }

    // Function to stop the camera
    function stopCamera(cameraFeedEl, cameraStatusMessageEl, startCameraBtnEl, stopCameraBtnEl, takePhotoBtnEl, startRecordBtnEl, stopRecordBtnEl, toggleCameraBtnEl) {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraFeedEl.srcObject = null;
            cameraFeedEl.classList.add('hidden');
            cameraStatusMessageEl.textContent = 'Camera stopped.';

            updateCameraButtons(false, false, false, {startCameraBtnEl, stopCameraBtnEl, takePhotoBtnEl, startRecordBtnEl, stopRecordBtnEl, toggleCameraBtnEl});

            // Stop recording if active
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
        }
    }

    // Function to take a photo
    function takePhoto(cameraFeedEl, photoCanvasEl, capturedPhotoEl, recordedVideoPlaybackEl, cameraStatusMessageEl) {
        if (cameraFeedEl.srcObject) {
            photoCanvasEl.width = cameraFeedEl.videoWidth;
            photoCanvasEl.height = cameraFeedEl.videoHeight;
            const context = photoCanvasEl.getContext('2d');
            context.drawImage(cameraFeedEl, 0, 0, photoCanvasEl.width, photoCanvasEl.height);
            const dataUrl = photoCanvasEl.toDataURL('image/png');
            capturedPhotoEl.src = dataUrl;
            capturedPhotoEl.classList.remove('hidden');
            recordedVideoPlaybackEl.classList.add('hidden'); // Hide video playback if photo is taken
            recordedVideoPlaybackEl.src = '';
            cameraStatusMessageEl.textContent = 'Photo captured!';
        } else {
            cameraStatusMessageEl.textContent = 'No camera feed to capture photo.';
        }
    }

    // Function to start recording video
    function startRecording(cameraStream, cameraStatusMessageEl, startRecordBtnEl, stopRecordBtnEl, takePhotoBtnEl, capturedPhotoEl, recordedVideoPlaybackEl, toggleCameraBtnEl) {
        if (cameraStream && MediaRecorder.isTypeSupported('video/webm')) {
            recordedChunks = [];
            mediaRecorder = new MediaRecorder(cameraStream, { mimeType: 'video/webm' });

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const videoUrl = URL.createObjectURL(blob);
                recordedVideoPlaybackEl.src = videoUrl;
                recordedVideoPlaybackEl.classList.remove('hidden');
                capturedPhotoEl.classList.add('hidden'); // Hide photo if video is recorded
                cameraStatusMessageEl.textContent = 'Recording stopped. Video ready for playback.';
            };

            mediaRecorder.start();
            cameraStatusMessageEl.textContent = 'Recording...';
            updateCameraButtons(true, true, false, {startCameraBtnEl, stopCameraBtnEl, takePhotoBtnEl, startRecordBtnEl, stopRecordBtnEl, toggleCameraBtnEl}); // Pass all relevant elements
        } else {
            cameraStatusMessageEl.textContent = 'Recording not supported or no camera active.';
            addLog('system', 'Video recording not supported by your browser or no camera stream available.', false);
        }
    }

    // Function to stop recording video
    function stopRecording(mediaRecorder, cameraStatusMessageEl, startRecordBtnEl, stopRecordBtnEl, takePhotoBtnEl, toggleCameraBtnEl) {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            cameraStatusMessageEl.textContent = 'Stopping recording...';
            updateCameraButtons(true, false, false, {startCameraBtnEl, stopCameraBtnEl, takePhotoBtnEl, startRecordBtnEl, stopRecordBtnEl, toggleCameraBtnEl}); // Pass all relevant elements
        }
    }

    // Function to toggle between front and rear cameras
    async function toggleCameraFacingMode(cameraFeedEl, cameraStatusMessageEl, startCameraBtnEl, stopCameraBtnEl, takePhotoBtnEl, startRecordBtnEl, stopRecordBtnEl, toggleCameraBtnEl, capturedPhotoEl, recordedVideoPlaybackEl) {
        if (!cameraStream) {
            cameraStatusMessageEl.textContent = 'Camera not active to toggle.';
            return;
        }

        // Stop current stream
        cameraStream.getTracks().forEach(track => track.stop());
        cameraFeedEl.srcObject = null;

        // Toggle facing mode
        currentFacingMode = (currentFacingMode === 'user') ? 'environment' : 'user';

        // Restart camera with new facing mode
        await startCamera(cameraFeedEl, cameraStatusMessageEl, startCameraBtnEl, stopCameraBtnEl, takePhotoBtnEl, startRecordBtnEl, stopRecordBtnEl, toggleCameraBtnEl, capturedPhotoEl, recordedVideoPlaybackEl, currentFacingMode);
    }


    // --- Event Listener Setup ---
    function initializeToolkitListeners(obotCommandInput, documentQueryInput) { // Added parameters
        // --- Initialize Quill Editor ---
        const toolbarOptions = [
            ['bold', 'italic', 'underline', 'strike'],         // toggled buttons
            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            [{ 'script': 'sub'}, { 'script': 'super' }],       // superscript/subscript
            [{ 'indent': '-1'}, { 'indent': '+1' }],           // outdent/indent
            [{ 'align': [] }],
            ['link', 'image', 'video'],                        // link, image, video
            ['clean']                                          // remove formatting button
        ];

        quillEditor = new Quill('#document-editor', {
            modules: {
                toolbar: toolbarOptions,
            },
            theme: 'snow' 
        });

        // Set initial content or load from storage
        quillEditor.root.innerHTML = '<p class="text-gray-300">Welcome to the Document Viewer. AI-generated agreements and reviewed documents will appear here. You can also draft your own documents using these editing tools!</p>';
        
        // --- Command Line Listeners ---
        const commandForm = document.getElementById('command-form');
        if (commandInput && commandForm) { 
            commandForm.addEventListener('submit', (e) => {
                e.preventDefault();
                window.handleCommand(commandInput.value.trim()); // Call global handleCommand
                commandInput.value = ''; 
            });
        } else {
            console.error("initializeToolkitListeners: commandForm not found.");
        }
      
        // --- Clear Log Button Listener ---
        if (clearLogBtn) {
            clearLogBtn.addEventListener('click', window.clearLog);
        } else {
            console.error("initializeToolkitListeners: clearLogBtn not found.");
        }
        
        // --- CORE MODULES BUTTON LISTENERS ---
        const quickbooksBtn = document.getElementById('module-quickbooks-sync');
        if (quickbooksBtn) {
            quickbooksBtn.addEventListener('click', () => {
                window.handleCommand('core.quickbooks_sync', quickbooksBtn);
            });
        }
        const leadGenBtn = document.getElementById('module-lead-gen');
        if (leadGenBtn) {
            leadGenBtn.addEventListener('click', () => {
                window.handleCommand('core.lead_generation', leadGenBtn);
            });
        }
        const reportingBtn = document.getElementById('module-reporting');
        if (reportingBtn) {
            reportingBtn.addEventListener('click', () => {
                window.handleCommand('core.reporting', reportingBtn);
            });
        }
        const hrBtn = document.getElementById('module-hr');
        if (hrBtn) {
            hrBtn.addEventListener('click', () => {
                window.handleCommand('core.hr_management', hrBtn);
            });
        }

        // --- OBOT Command Input Listener ---
        if (obotCommandInput) {
            obotCommandInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const query = obotCommandInput.value.trim();
                    if (query) {
                        // Pass to global handleCommand with chatbot prefix
                        window.handleCommand(`chatbot: ${query}`); 
                        obotCommandInput.value = '';
                    }
                }
            });
        } else {
            console.error("initializeToolkitListeners: obotCommandInput not found.");
        }

        // --- Document Query Input Listener ---
        if (documentQueryInput) {
            documentQueryInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const query = documentQueryInput.value.trim();
                    if (query) {
                        // Get the current content of the document viewer for context
                        const documentContent = quillEditor ? quillEditor.root.innerHTML : '';
                        // Pass to global handleCommand with document_query prefix
                        window.handleCommand(`document_query: ${query}\nDocument Content: ${documentContent}`); 
                        documentQueryInput.value = '';
                    }
                }
            });
        } else {
            console.error("initializeToolkitListeners: documentQueryInput not found.");
        }

        // --- Tab Listeners ---
        const tabButtons = document.querySelectorAll('.tab-button');
        if (tabButtons.length > 0) {
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    const targetTabId = button.dataset.tab;
                    const targetTab = document.getElementById(targetTabId);
                    if (targetTab) {
                        targetTab.classList.add('active');
                    }
                });
            });
        } else {
            console.error("initializeToolkitListeners: No tab buttons found.");
        }

        // --- Specifications Logic ---
        if (serviceSpecsDropdownBtn && serviceSpecsDropdown && serviceSpecsList) {
            // Populate service specs dropdown
            for (const key in serviceDefinitions) {
                const label = document.createElement('label');
                label.className = 'flex items-center p-2 hover:bg-gray-800 cursor-pointer';
                label.innerHTML = `<input type="radio" name="service-package" value="${key}" class="mr-2"> ${key.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}`;
                serviceSpecsList.appendChild(label);
            }

            serviceSpecsDropdownBtn.addEventListener('click', (e) => {
                e.stopPropagation(); 
                serviceSpecsDropdown.classList.toggle('hidden');
            });

            serviceSpecsDropdown.addEventListener('click', (e) => {
                if (e.target.type === 'radio') {
                    serviceSpecsDropdownBtn.textContent = e.target.parentElement.textContent.trim();
                    serviceSpecsDropdown.classList.add('hidden');
                }
            });

            // Close dropdown if clicked outside
            document.addEventListener('click', (e) => {
                if (!serviceSpecsDropdownBtn.contains(e.target) && !serviceSpecsDropdown.contains(e.target)) {
                    serviceSpecsDropdown.classList.add('hidden');
                }
            });
        } else {
            console.error("initializeToolkitListeners: Service specs dropdown elements not found.");
        }


        // --- Calculator Listeners ---
        if (daysSelect && daysSelect.options.length === 0) {
            for (let i = 1; i <= 30; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                daysSelect.appendChild(option);
            }
            daysSelect.value = 5;
        } else if (!daysSelect) {
            console.error("initializeToolkitListeners: calc-days select element not found.");
        }

        if (fetchSqftBtn) {
            fetchSqftBtn.addEventListener('click', (e) => {
                // Now using calcAddressInput directly
                if (!calcAddressInput || !calcAddressInput.value) {
                    addLog('system', 'Please enter a property address to fetch data.', false);
                    return;
                }
                addLog('system', `Simulating public records search for: ${calcAddressInput.value}...`, false);
                const simulatedSqFt = Math.floor(Math.random() * (50000 - 2000 + 1)) + 2000;
                // Now using calcSqftInput directly
                if (calcSqftInput) {
                    calcSqftInput.value = simulatedSqFt;
                }
                addLog('system', `Data retrieved. Estimated property size: ${simulatedSqFt} sq ft.`, false);
            });
        } else {
            console.error("initializeToolkitListeners: fetchSqftBtn not found.");
        }


        if (calculateBidBtn) {
            calculateBidBtn.addEventListener('click', async (e) => {
                // Using global variables directly
                const clientName = calcClientNameInput ? calcClientNameInput.value : '';
                const address = calcAddressInput ? calcAddressInput.value : ''; // Added address to pass to Python
                const sqFt = calcSqftInput ? calcSqftInput.value : '';
                const hours = calcHoursInput ? calcHoursInput.value : '';
                const people = calcEmpInput ? calcEmpInput.value : '';
                const pricePerSqFt = calcPricePerSqftInput ? calcPricePerSqftInput.value : '';
                const days = calcDaysInput ? calcDaysInput.value : '';
                const serviceSpecsSelect = document.querySelector('#service-specs-dropdown input[name="service-package"]:checked');
                const serviceSpecs = serviceSpecsSelect ? serviceSpecsSelect.value : '';
            
                if (!clientName || !address || !sqFt || !hours || !people || !pricePerSqFt || !serviceSpecs || !days) { 
                    addLog('system', 'All required bid fields are empty. Please fill out all fields.', false);
                    return;
                }

                const serviceDefinition = serviceDefinitions[serviceSpecs];

                // Updated directive to reflect removed fields and added address
                const directive = `math.calculate bid for client: ${clientName}, address: ${address}, sqft: ${sqFt}, price_per_sqft: ${pricePerSqFt}, num_emp: ${people}, hours_per_day: ${hours}, days_per_month: ${days}, specs: ${serviceDefinition}`;
                const userLog = `Calculate bid: Client: ${clientName}, SqFt: ${sqFt}, Hrs/Day: ${hours}, #Emp: ${people}, Price/SqFt: $${pricePerSqFt}, Days/Mo: ${days}, Package: ${serviceSpecs}`;

                handleCommand(directive, calculateBidBtn); 
            });
        } else {
            console.error("initializeToolkitListeners: calculateBidBtn not found.");
        }
        
        if (generateAgreementBtn) { 
            generateAgreementBtn.addEventListener('click', async () => {
                // Pulling data from the client details in the calculator tab
                const clientName = calcClientNameInput ? calcClientNameInput.value : '';
                const clientAddress = calcAddressInput ? calcAddressInput.value : '';
                const serviceCost = calcFlatRateInput ? calcFlatRateInput.value : ''; // Using flat rate as monthly cost

                // Defaulting service details for agreement if not explicitly selected for agreement
                const selectedServiceText = "Full-Service Janitorial"; 
                const serviceDefinition = serviceDefinitions['full-service']; 


                if (!clientName || !clientAddress || !serviceCost) { 
                    addLog('system', 'Client Name, Address, and Monthly Cost (Flat Rate) are required to generate an agreement. Please fill these in the Calculator tab.', false);
                    return;
                }
                
                const directive = `law.generate a legally binding service agreement for Howard Janitorial Services. The client is ${clientName} at ${clientAddress}. The monthly cost is $${serviceCost}. The service is the "${selectedServiceText}" package, defined as "${serviceDefinition}". The agreement must be governed by the laws of the State of Georgia. It must include strong clauses covering: Scope of Work, Payment Terms (Net 30), severe Late Payment Penalties (e.g., 1.5% monthly interest), Consequences of Non-Payment (including collections and legal action), Term and Termination (30-day notice), Confidentiality, and Limitation of Liability. The tone must be formal, legally robust, and designed to protect HJS from non-payment.`;
                const userLog = `Generate Service Agreement for: ${clientName}`;

                handleCommand(directive, generateAgreementBtn); 
            });
        } else {
            console.error("initializeToolkitListeners: generate-agreement-btn not found."); 
        }

        // --- Approval Button Listener ---
        if (approveBidBtn) {
            approveBidBtn.addEventListener('click', (e) => {
                if (pendingAgreement) {
                    addLog('system', "Bidder approved. Simulating admin review and generating final client agreement.", false);
                    displayInViewport(pendingAgreement);
                    e.currentTarget.classList.add('hidden');
                    pendingAgreement = "";
                }
            });
        } else {
            console.error("initializeToolkitListeners: approve-bid-btn not found."); 
        }

        // --- Drag and Drop Listeners (Admin Only) ---
        if (viewport) { 
            viewport.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                viewport.classList.add('drag-over');
            });

            viewport.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                viewport.classList.remove('drag-over');
              
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type.startsWith('text/')) {
                        const reader = new FileReader();
                        reader.onload = (readEvent) => {
                            const content = readEvent.target.result;
                            const command = `compsci.review_document: ${file.name}:\n\n${content}`;
                            handleCommand(command);
                        };
                        reader.readAsText(file);
                    } else {
                        addLog('system', `Error: Only text files (.txt, .md, etc.) can be dropped for review.`, false);
                    }
                }
            });
        } else {
            console.error("initializeToolkitListeners: viewport for drag and drop not found.");
        }

        // --- Camera Button Event Listeners ---
        // Retrieve camera DOM elements locally within this function
        const cameraFeedEl = document.getElementById('camera-feed');
        const photoCanvasEl = document.getElementById('photo-canvas');
        const capturedPhotoEl = document.getElementById('captured-photo');
        const recordedVideoPlaybackEl = document.getElementById('recorded-video-playback');
        const cameraStatusMessageEl = document.getElementById('camera-status-message');
        const startCameraBtnEl = document.getElementById('start-camera-btn');
        const stopCameraBtnEl = document.getElementById('stop-camera-btn');
        const takePhotoBtnEl = document.getElementById('take-photo-btn');
        const startRecordBtnEl = document.getElementById('start-record-btn');
        const stopRecordBtnEl = document.getElementById('stop-record-btn');
        const toggleCameraBtnEl = document.getElementById('toggle-camera-btn'); // Get the new toggle button

        if (startCameraBtnEl) startCameraBtnEl.addEventListener('click', () => startCamera(cameraFeedEl, cameraStatusMessageEl, startCameraBtnEl, stopCameraBtnEl, takePhotoBtnEl, startRecordBtnEl, stopRecordBtnEl, toggleCameraBtnEl, capturedPhotoEl, recordedVideoPlaybackEl));
        if (stopCameraBtnEl) stopCameraBtnEl.addEventListener('click', () => stopCamera(cameraFeedEl, cameraStatusMessageEl, startCameraBtnEl, stopCameraBtnEl, takePhotoBtnEl, startRecordBtnEl, stopRecordBtnEl, toggleCameraBtnEl));
        if (takePhotoBtnEl) takePhotoBtnEl.addEventListener('click', () => takePhoto(cameraFeedEl, photoCanvasEl, capturedPhotoEl, recordedVideoPlaybackEl, cameraStatusMessageEl));
        if (startRecordBtnEl) startRecordBtnEl.addEventListener('click', () => startRecording(cameraStream, cameraStatusMessageEl, startRecordBtnEl, stopRecordBtnEl, takePhotoBtnEl, capturedPhotoEl, recordedVideoPlaybackEl, toggleCameraBtnEl)); // Added toggleCameraBtnEl
        if (stopRecordBtnEl) stopRecordBtnEl.addEventListener('click', () => stopRecording(mediaRecorder, cameraStatusMessageEl, startRecordBtnEl, stopRecordBtnEl, takePhotoBtnEl, toggleCameraBtnEl)); // Added toggleCameraBtnEl
        if (toggleCameraBtnEl) toggleCameraBtnEl.addEventListener('click', () => toggleCameraFacingMode(cameraFeedEl, cameraStatusMessageEl, startCameraBtnEl, stopCameraBtnEl, takePhotoBtnEl, startRecordBtnEl, stopRecordBtnEl, toggleCameraBtnEl, capturedPhotoEl, recordedVideoPlaybackEl));
    }

